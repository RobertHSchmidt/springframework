<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;5.&nbsp;Flow executors</title><link rel="stylesheet" href="../styles/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.60.1"><link rel="home" href="index.html" title="Spring Web Flow"><link rel="up" href="index.html" title="Spring Web Flow"><link rel="previous" href="flow-execution-repository.html" title="Chapter&nbsp;4.&nbsp;Flow execution repositories"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:#31430f;border:none;height:110px;border:1px solid black;"><a style="border:none;background: url();" href="http://www.springframework.org/" title="The Spring Framework"><img style="border:none;" src="images/banner4.jpg"></a><a style="border:none;background: url();" href="http://www.interface21.com/" title="Interface21 - Spring from the Source"><img style="border:none;position:absolute;right:32px;" src="images/bannerR.gif"></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="flow-executor"></a>Chapter&nbsp;5.&nbsp;Flow executors</h2></div></div><div></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor-intro"></a>5.1.&nbsp;Introduction</h2></div></div><div></div></div><p>
			Flow executors are the highest-level entry points into
			the Spring Web Flow system, responsible for driving the execution of flows
			across a variety of environments.
		</p><p>
			In this chapter you'll learn how to execute flows within Spring MVC, Struts, 
			and Java Server Faces (JSF) based applications.
		</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor"></a>5.2.&nbsp;FlowExecutor</h2></div></div><div></div></div><p>
    		<tt class="literal">org.springframework.webflow.FlowExecutor</tt> is the 
    		central facade interface external systems use to drive the execution of flows.
    		This facade acts as a simple, convenient service entry-point into
    		the Spring Web Flow system that is reusable across environments.
    	</p><p>
    		The <tt class="literal">FlowExecutor</tt> interface is shown below:
    	</p><pre class="programlisting">
    public interface FlowExecutor {
        ResponseInstruction launch(String flowId, ExternalContext context);
        ResponseInstruction signalEvent(String eventId, String flowExecutionKey, ExternalContext context);
        ResponseInstruction refresh(String flowExecutionKey, ExternalContext context);
    }    	
    	</pre><p>
    		As you can see there are three central use-cases fulfilled by this interface:
    		</p><div class="orderedlist"><ol type="1"><li><p>
    					Launch (start) a new top-level flow execution.
    				</p></li><li><p>
    					Resume a paused flow execution by signaling an event in its current state.
    				</p></li><li><p>
    					Request that the last response issued by a flow execution be re-issued. 
    					Unlike start and signalEvent, the refresh operations are idempotent operations
    					that does not affect the state of a flow execution.
    				</p></li></ol></div><p>
    	</p><p>
    		Each operation accepts an <tt class="literal">ExternalContext</tt> that provides normalized 
    		access to properties of an external system that has called into Spring Web Flow, allowing
    		access to environment-specific request parameters as well as request, session, and
    		application-level attributes.
    	</p><p>
    		Each operation returns a <tt class="literal">ResponseInstruction</tt> which the calling system is 
    		expected to use to issue a suitable response.
    	</p><p>
    		These relationships are shown graphically below:
    	</p><div class="mediaobject" align="center"><img src="images/flowexecutorfacade-classdiagram.png" align="middle"><div class="caption"><p>Flow executor</p></div></div><p>
			As you can see, an <tt class="literal">ExternalContext</tt> implementation exists for each of
			the environments Spring Web Flow supports.  If a flow artifact such as an Action needs
			to access native constructs of the calling environment it can downcast a context to its
			specific implementation.  The need for such downcasting is considered a special case.
		</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="flowexecutor-impl"></a>5.2.1.&nbsp;FlowExecutorImpl</h3></div></div><div></div></div><p>
    			The default executor implementation is <tt class="literal">org.springframework.webflow.executor.FlowExecutorImpl</tt>.
    			It allows for configuration of the flow locator responsible for loading the flow definitions to execute, as well as
    			the flow execution repository strategy responsible for persisting flow executions that remain 
    			active beyond a single request into the server.
    		</p><p>
    			The configurable <tt class="literal">FlowExecutorImpl</tt> properties are shown below:
    		</p><div class="table"><a name="d0e2977"></a><p class="title"><b>Table&nbsp;5.1.&nbsp;FlowExecutorImpl properties</b></p><table summary="FlowExecutorImpl properties" border="1"><colgroup><col><col><col><col></colgroup><thead><tr><th>Property name</th><th>Description</th><th>Cardinality</th><th>Default value</th></tr></thead><tbody><tr><td>flowLocator</td><td>The service for loading flow definitions to be executed, typically a flow registry</td><td><span class="emphasis"><em>1</em></span></td><td class="auto-generated">&nbsp;</td></tr><tr><td>repositoryFactory</td><td>The factory for loading repositories to create, save, and restore flow executions</td><td><span class="emphasis"><em>1</em></span></td><td>DefaultFlowExecutionRepositoryFactory</td></tr></tbody></table></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-simple"></a>5.2.2.&nbsp;A typical flow executor configuration</h3></div></div><div></div></div><pre class="programlisting">
    &lt;bean id="flowExecutor" class="org.springframework.webflow.executor.FlowExecutorImpl"&gt;
        &lt;constructor-arg ref="flowRegistry"/&gt;
    &lt;/bean&gt;
		
    &lt;bean id="flowRegistry" class="org.springframework.webflow.registry.XmlFlowRegistryFactoryBean"&gt;
        &lt;property name="flowLocations" value="/WEB-INF/flows/**/*-flow.xml"/&gt;
    &lt;/bean&gt;
	    	</pre></div><p>
    		This instructs Spring to create a flow executor that can execute all XML-based flow definitions 
    		contained within the <tt class="literal">/WEB-INF/flows</tt> directory.
    	</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-custom-repo"></a>5.2.3.&nbsp;A flow executor with a custom repository factory</h3></div></div><div></div></div><pre class="programlisting">
    &lt;bean id="flowExecutor" class="org.springframework.webflow.executor.FlowExecutorImpl"&gt;
        &lt;constructor-arg ref="repositoryFactory"/&gt;
    &lt;/bean&gt;

    &lt;bean id="repositoryFactory" class="org.springframework.webflow.execution.repository.continuation.ContinuationFlowExecutionRepositoryFactory"&gt;
        &lt;constructor-arg ref="flowRegistry"/&gt;
    &lt;/bean&gt;
				
    &lt;bean id="flowRegistry" class="org.springframework.webflow.registry.XmlFlowRegistryFactoryBean"&gt;
        &lt;property name="flowLocations" value="/WEB-INF/flows/**/*-flow.xml"/&gt;
    &lt;/bean&gt;
	    	</pre></div><p>
    		This executor is configured with a continuation-based repository factory which creates 
    		stateful continuation repositories managed in the user session.
    	</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor-mvc"></a>5.3.&nbsp;Spring MVC integration</h2></div></div><div></div></div><p>
			Spring Web Flow integrates with both Servlet and Portlet MVC which ship with the 
			core Spring Framework.  Use of Portlet MVC requires Spring 2.0.
		</p><p>
			For both Servlet and Portlet MVC a <tt class="literal">FlowController</tt> acts as an adapter
			between Spring MVC and Spring Web Flow.  As an adapter, this controller has knowledge 
			of both systems and delegates to a flow executor for driving the execution of flows.
			One controller typically executes all flows of an application, relying on 
			parameterization to determine what flow to launch or what flow execution to resume.
		</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-servletmvc"></a>5.3.1.&nbsp;A single flow controller executing all flows in a Servlet MVC environment</h3></div></div><div></div></div><pre class="programlisting">
    &lt;bean name="/flowController.htm" class="org.springframework.webflow.executor.mvc.FlowController"&gt;
        &lt;property name="flowExecutor" ref="flowExecutor"/&gt;
    &lt;/bean&gt;
	    	</pre></div><p>
    		This controller, exported at the context-relative <tt class="literal">/flowController.htm</tt> URL,
    		delegates to the configured flow executor for driving flow executions in a Spring Servlet 
    		MVC environment.
    	</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-portletmvc"></a>5.3.2.&nbsp;A single portlet flow controller executing a flow within a Portlet</h3></div></div><div></div></div><pre class="programlisting">
    &lt;bean id="portletModeControllerMapping" class="org.springframework.web.portlet.handler.PortletModeHandlerMapping"&gt;
        &lt;property name="portletModeMap"&gt;
            &lt;map&gt;
                &lt;entry key="view" value-ref="flowController"/&gt;
            &lt;/map&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;bean id="flowController" class="org.springframework.webflow.executor.mvc.PortletFlowController"&gt;
        &lt;property name="flowExecutor" ref="flowExecutor"/&gt;
        &lt;property name="defaultFlowId" ref="search-flow"/&gt;
    &lt;/bean&gt;
	    	</pre></div><p>
    		This controller, exported for access with the configured portlet mode,
    		delegates to the configured flow executor for driving flow executions in a Spring Portlet 
    		MVC environment (by default, an execution of the <tt class="literal">search-flow</tt>).
    	</p></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor-parameterization"></a>5.4.&nbsp;Flow executor parameterization</h2></div></div><div></div></div><p>
			Spring Web Flow allows for full control over how flow executor method parameters such as the
			<tt class="literal">flowId</tt>, <tt class="literal">flowExecutionKey</tt>, and <tt class="literal">eventId</tt> 
			are extracted from an incoming controller request with the <tt class="literal">org.springframework.webflow.executor.support.FlowExecutorArgumentExtractor</tt>
			strategy.  The default strategy is request-parameter based.  Support for request path-based 
			parameter extraction (REST-style URLs) is also provided.
		</p><p>
			The next several examples illustrate strategies for parameterizing flow controllers 
			from the browser to launch and resume flow executions:
		</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-launch-get"></a>5.4.1.&nbsp;Launching a flow execution - parameter-style anchor</h3></div></div><div></div></div><pre class="programlisting">
	&lt;a href="flowController.htm?_flowId=myflow"/&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-launch-get-rest"></a>5.4.2.&nbsp;Launching a flow execution - REST-style anchor</h3></div></div><div></div></div><pre class="programlisting">
	&lt;a href="flowController/myflow"/&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-launch-post"></a>5.4.3.&nbsp;Launching a flow execution - form</h3></div></div><div></div></div><pre class="programlisting">
    &lt;form action="flowController.htm" method="post"&gt;
        &lt;input type="submit" value="Go"/&gt;
        &lt;input type="hidden" name="_flowId" value="myflow"&gt;
    &lt;/form&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-resume-anchor"></a>5.4.4.&nbsp;Resuming a flow execution - anchor</h3></div></div><div></div></div><pre class="programlisting">
    &lt;a href="flowController.htm?_flowExecutionKey=${flowExecutionKey}&amp;eventId=submit"/&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-resume-form"></a>5.4.5.&nbsp;Resuming a flow execution - form</h3></div></div><div></div></div><pre class="programlisting">
    &lt;form action="flowController.htm" method="post"&gt;
        ...
        &lt;input type="hidden" name="_flowExecutionKey" value="${flowExecutionKey}"&gt;
        &lt;input type="hidden" name="_eventId" value="submit"/&gt;
        &lt;input type="submit" class="button" value="Submit"&gt;
    &lt;/form&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-mvc-resume-form-buttons"></a>5.4.6.&nbsp;Resuming a flow execution - multiple form buttons</h3></div></div><div></div></div><pre class="programlisting">
    &lt;form action="flowController.htm" method="post"&gt;
        ...
        &lt;input type="hidden" name="_flowExecutionKey" value="${flowExecutionKey}"&gt;
        &lt;input type="submit" class="button" name="_eventId_submit" value="Submit"&gt;
        &lt;input type="submit" class="button" name="_eventId_cancel" value="Cancel"&gt;
    &lt;/form&gt;
	    	</pre><p>
	    		Note in this case the <tt class="literal">eventId</tt> is determined by parsing the parameter name of the 
	    		button that was pressed.
	    	</p></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor-struts"></a>5.5.&nbsp;Struts integration</h2></div></div><div></div></div><p>
			Spring Web Flow integrates with Struts 1.x or &gt;.  The integration is very similiar to 
			Spring MVC where a single front controller (FlowAction) drives the execution of all flows
			for the application by delegating to a configured flow executor.
		</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-struts-simple"></a>5.5.1.&nbsp;A single flow action executing all flows</h3></div></div><div></div></div><pre class="programlisting">
    &lt;form-beans&gt;
        &lt;form-bean name="actionForm" type="org.springframework.web.struts.SpringBindingActionForm"/&gt;
    &lt;/form-beans&gt;
	    	
    &lt;action-mappings&gt;
        &lt;action path="/flowAction" name="actionForm" scope="request" type="org.springframework.webflow.executor.struts.FlowAction"/&gt;
    &lt;/action-mappings&gt;
	    	</pre></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="executor-jsf"></a>5.6.&nbsp;Java Server Faces (JSF) integration</h2></div></div><div></div></div><p>
			Spring Web Flow integrates with JSF.  The JSF integration relies on custom implementations of 
			core JSF artifacts such as navigation handler and phase listener to drive the 
			execution of flows.
		</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-jsf-simple"></a>5.6.1.&nbsp;A typical faces-config.xml file</h3></div></div><div></div></div><pre class="programlisting">
&lt;faces-config&gt;
    &lt;application&gt;
        &lt;navigation-handler&gt;
            org.springframework.webflow.executor.jsf.FlowNavigationHandler
        &lt;/navigation-handler&gt;
        &lt;property-resolver&gt;
            org.springframework.webflow.executor.jsf.FlowPropertyResolver
        &lt;/property-resolver&gt;
        &lt;variable-resolver&gt;
            org.springframework.webflow.executor.jsf.FlowVariableResolver
        &lt;/variable-resolver&gt;
        &lt;variable-resolver&gt;
            org.springframework.web.jsf.DelegatingVariableResolver
        &lt;/variable-resolver&gt;
        &lt;variable-resolver&gt;
            org.springframework.web.jsf.WebApplicationContextVariableResolver
        &lt;/variable-resolver&gt;
    &lt;/application&gt;

    &lt;lifecycle&gt;
        &lt;phase-listener&gt;org.springframework.webflow.executor.jsf.FlowPhaseListener&lt;/phase-listener&gt;
    &lt;/lifecycle&gt;
&lt;/faces-config&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-jsf-launch-get"></a>5.6.2.&nbsp;Launching a flow execution - command link</h3></div></div><div></div></div><pre class="programlisting">
    &lt;h:commandLink value="Go" action="flowId:myflow"/&gt;
	    	</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="executor-jsf-resume-form"></a>5.6.3.&nbsp;Resuming a flow execution - form</h3></div></div><div></div></div><pre class="programlisting">
    &lt;h:form id="form"&gt;
        ...
        &lt;h:inputText id="propertyName" value="#{flowScope.managedBeanName.propertyName}"/&gt;
        ...
        &lt;input type="hidden" name="_flowExecutionKey" value="${flowExecutionKey}"&gt;
        &lt;h:commandButton type="submit" value="Next" action="submit"/&gt;
    &lt;/h:form&gt;
	    	</pre></div></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="samples"></a>5.7.&nbsp;Sample applications</h2></div></div><div></div></div><p>
			It is recommended that you review the Spring Web Flow sample applications included in the 
			release distribution for best-practice illustrations of the features of this framework.
			A description of each sample is provided below:
    	</p><p>
    		</p><div class="orderedlist"><ol type="1"><li><p>Phonebook - the original sample demonstrating most features (including subflows).</p></li><li><p>Sellitem - demonstrates a wizard with conditional transitions, conversational scope, flow execution redirects, and continuations.</p></li><li><p>Flowlauncher - demonstrates all the possible ways to launch and resume flows.</p></li><li><p>Itemlist - demonstrates REST-style URLs, conversational redirects, and inline flows.</p></li><li><p>Shippingrate - demonstrates Spring Web Flow together with Ajax technology.</p></li><li><p>NumberGuess - demonstrates use of stateful middle-tier components to carry out business logic.</p></li><li><p>Birthdate - demonstrates Struts integration and the MultiAction.</p></li><li><p>Fileupload - demonstrates multipart file upload.</p></li><li><p>Phonebook-Portlet - the phonebook sample in a Portlet environment (notice how the flow definitions do not change)</p></li><li><p>Sellitem-JSF - the sellitem sample in a JSF environment (notice how the flow definition is more concise)</p></li></ol></div><p>
    	</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="flow-execution-repository.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="index.html">Up</a></td><td width="40%" align="right">&nbsp;</td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;4.&nbsp;Flow execution repositories&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;</td></tr></table></div></body></html>