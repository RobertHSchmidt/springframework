<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE flow PUBLIC "-//SPRING//DTD WEBFLOW 1.0//EN"
	"http://www.springframework.org/dtd/spring-webflow-1.0.dtd">

<flow start-state="fillCart">

	<var name="cart" class="swf.sushi.ShoppingCart"/>
	
	<subflow-state id="fillCart" flow="fillCart-flow">
		<attribute-mapper>
			<input-mapper>
				<mapping source="flowScope.cart" target="cart"/>
			</input-mapper>
		</attribute-mapper>
		<transition on="checkout" to="enterShipping"/>
	</subflow-state>
	
	<subflow-state id="enterShipping" flow="address-flow">
		<attribute-mapper>
			<input-mapper>
				<mapping source="'Please enter your shipping address'" target="message"/>
			</input-mapper>
			<output-mapper>
				<mapping source="shipping" target="flowScope.shipping"/>
			</output-mapper>
		</attribute-mapper>
		<transition on="finish" to="enterPaymentInfo"/>
	</subflow-state>
	
	<view-state id="useAsBilling" view="useAsBilling">
		<transition on="yes" to="enterBilling"/>
		<transition on="no" to="enterPaymentInfo"/>
	</view-state>	
	
	<subflow-state id="enterBilling" flow="address-flow">
		<attribute-mapper>
			<input-mapper>
				<mapping source="'Please enter your billing address'" target="message"/>
			</input-mapper>
			<output-mapper>
				<mapping source="billing" target="flowScope.billing"/>
			</output-mapper>
		</attribute-mapper>
		<transition on="finish" to="enterPaymentInfo"/>
	</subflow-state>

	<subflow-state id="enterPaymentInfo" flow="payment-flow">
		<attribute-mapper>
			<output-mapper>
				<mapping source="creditCard" target="flowScope.creditCard"/>
			</output-mapper>
		</attribute-mapper>
		<transition on="finish" to="placeOrder"/>
	</subflow-state>
	
	<action-state id="placeOrder">
		<action bean="orderClerk" method="placeOrder(${flowScope.cart}, ${flowScope.shipping}, ${flowScope.billing}, ${flowScope.creditCard})"/>
		<transition on="success" to="displayConfirmation"/>
	</action-state>
	
	<end-state id="displayConfirmation" view="confirmation"/>
		
</flow>